<!DOCTYPE html>
<html>
<head>
    <title>SpoonFed</title>
    <meta name=viewport content="width=device-width, initial-scale=1">

    <!--Link to the font Open Sans-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,600italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="css/base.css" />
    <link rel="stylesheet" type="text/css" href="css/summary.css" />

    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/isotope/dist/isotope.pkgd.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>

<<<<<<< Updated upstream
    <script type="text/javascript">

        (function() {

            var Spoonfed = function() {
                this.news = {};
            };

            Spoonfed.prototype.fetch = function(newsSource) {
                if(this.news[newsSource]) {
                    return this.news[newsSource];
                }
                //request for rss feed to google
                return $.ajax({
                    type:       'GET',
                    url:        'http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=9&q=' + Spoonfed.sources[newsSource],
                    dataType:   'jsonp'
                })
                //after the request
                .then(function(data) //take the data and do stuff with it
                 {
                    this.news[newsSource] = data.responseData.feed.entries;
                    console.log('entries:', this.news[newsSource]);
                    return this.news[newsSource];
                }.bind(this))
                .then(function(articles //the data that's passed through
                    ) {
                    //the promises array
                    var promises = [];
                    //the request for summarisation
                    function getSummary(article) {
                        return $.ajax({
                            url: "https://joanfihu-article-analysis-v1.p.mashape.com/link?entity_description=False&link=" + encodeURI(article.link),
                            type: "GET",
                            headers: {"X-Mashape-Key": "Ul1DH83LxvmshqXbCrkoyi6dEZX0p18mLJZjsn3gJ1NQuk9VEG"}
                        }).then(function(summarised) {
                            //doing stuff with the result
                            article.summary = summarised.summary.join(' ');
                            article.keywords = summarised.tags.join(',');
                            //returning the data
                            return articles;
                        });
                    }
                    //the actual running of the getSummary, put into an array of promises
                    articles.forEach(function(article) {
                        promises.push(getSummary(article));
                    });
                    //when all of these have been resolved
                    return $.when.apply($, promises);
                    //do the next bit
                }).then(function(articles) {
                    var promisesArray = [];

                    function getFlickrImage(article) {
                        return $.getJSON('https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=25a70c36ed90ccaaec306db51793afdd&tags=' + article.keywords + '&format=json&per_page=1&jsoncallback=?')
                            .then(function(imageData) {
                                var firstPhoto = imageData.photos.photo[0];
                                var id = firstPhoto.id;
                                var farm = firstPhoto.farm;
                                var server = firstPhoto.server;
                                var secret = firstPhoto.secret;

                                article.photoUrl = 'https://farm' + farm + '.staticflickr.com/' + server + '/' + id + '_' + secret + '.jpg';

                                return articles;
                            });
                    }

                    articles.forEach(function(article) {
                        promisesArray.push(getFlickrImage(article));
                    });
                    console.log('promises', promisesArray);
                    return $.when.apply($, promisesArray);
                });
            };

            Spoonfed.sources = {
                sky: 'http://feeds.bbci.co.uk/news/rss.xml'
            };

            this.Spoonfed = Spoonfed;

        }).apply(window)

        $(function() {
            var s = new Spoonfed();
            s.fetch('sky').then(function(f) {
                console.log('finally', f);
            
                var t = $("#articletemplate").text();
                var mo = _.template(t);
                var c1 = mo({articles: f});
                $('#container').append(c1);
                $('.spinner').hide();
            });
        });
=======
<script type="text/javascript">
        if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $('.item').css("margin", "auto");
        }
>>>>>>> Stashed changes

        $('#container').isotope({
            // options...
            itemSelector: '.item',
            masonry: {
                columnWidth: 200
            }
        });
        var $container = $("#container");


var getFeedURLs = function(feed, id) {
     console.log(id);
      return $.ajax({
            url: "http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&q=" + feed,
            type: "GET",
            dataType: "jsonp"
            })
          .then(function(data) {
            data.responseData.feed.entries.ios = id;
            return data.responseData.feed.entries;
          });
}
var summarise = function(data){
      return $.ajax({
    url: "https://joanfihu-article-analysis-v1.p.mashape.com/link?entity_description=False&link=" + encodeURI(data.link),
    type: "GET",
    headers: {"X-Mashape-Key": "Ul1DH83LxvmshqXbCrkoyi6dEZX0p18mLJZjsn3gJ1NQuk9VEG"}
      })
      .then(function(callback) {
        data.summary = callback.summary.join(' ');
        data.keywords = callback.tags;
        data.photourl = callback.image;
        return data;
      }); 
}
var getFlickr = function(data){

      return $.getJSON("https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=25a70c36ed90ccaaec306db51793afdd&tags=" + data.keywords.join(',') + "&format=json&per_page=1&jsoncallback=?")
      .then(function(callback) {
        id = (callback.photos.photo[0].id);
        farm = (callback.photos.photo[0].farm);
        server = (callback.photos.photo[0].server);
        secret = (callback.photos.photo[0].secret);
        photourl = "https://farm" + farm + ".staticflickr.com/" + server + "/" + id + "_" + secret + ".jpg";
        data.photourl = photourl;
        return data;
      });
}
var buildArticle = function(data) {
    var array = [];
    array.push(data);
    var t = $("#articletemplate").text();
    var mo = _.template(t);
    var newItem = mo({articles: array});
    $('#container').append(newItem);
}
var cleanUp = function(data) {
    delete data.mediaGroups;
    delete data.author;
    delete data.publishedDate;
    delete data.content;
    delete data.contentSnippet;
    delete data.__proto__;
    delete data.categories;
    return data;

}
    var getAricles = function(feed, id){
    getFeedURLs(feed, id)
    .then(function(data) {
        var l = data.length;
        for (var o=0;o<l;o++){
            data[o].ios = data.ios;
            summarise(data[o])
            .then(buildArticle)
            .then(check);
        }
    });
}

var clear = function(){
    $('#container').empty();
}
var check = function(){
    if( !$.trim( $('#container').html() ).length ) {
        console.log('almost')
    }else{
        $('.spinner').hide();
    }      
}
        var articles = [];
        var feed = ["http://feeds.bbci.co.uk/news/politics/rss.xml","http://feeds.bbci.co.uk/news/science_and_environment/rss.xml","http://feeds.bbci.co.uk/news/technology/rss.xml","http://feeds.bbci.co.uk/news/rss.xml"];
        var id = ["politics", "science", "technology","World"];
        getAricles(feed[3], id[3]);
        getAricles(feed[0], id[0]);
        getAricles(feed[1], id[1]);
        getAricles(feed[2], id[2]);


</script>
    <script type="text/template" id="articletemplate">
    <% _.each(articles, function(article) { %>

    <div class="item">
    <div class="catagory" id="<%= article.ios %>">
    <h1><%= article.ios %></h1></div>
    <div class="photos" style='background-image:url("<%= article.photourl %>"); background-size: cover;'>
    </div>
    <p style="text-align:center;">
      <a href="<%= article.link %>" target="_blank">
        <%= article.title %>
      </a>
    </p>
    <p><%= article.summary %></p>
      <div id="this">
      </div>
    </div>
    <%}); %>
    </script>
</head>
<body>
    <header>
        <div class="headerimage">
            <img src="images/spoonfedheader-01.png" width="250px">
        </div>

    </header>
    <div class="main">
        <div id="container">
        <div class="spinner">
            <img src="images/ajax-loader-2.gif">
        </div>
        </div>
    <footer>
        <div class="footerimage">
            <img src="images/spoonfedfooter.svg" width="80px">
        </div>
    </footer>
</body>
</html>
